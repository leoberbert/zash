name: Build Packages

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  arch:
    name: Arch PKGBUILD
    runs-on: ubuntu-latest
    container: archlinux:latest
    steps:
      - name: Install build prerequisites
        run: |
          pacman -Syu --noconfirm git base-devel sudo
      - uses: actions/checkout@v4
      - name: Install runtime deps required by PKGBUILD
        run: |
          pacman -S --noconfirm \
            python python-build python-installer python-uv-build python-wheel \
            gtk4 libadwaita vte4 libsecret rsync sshpass
      - name: Create build user
        run: |
          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers
          chown -R builder:builder /__w || true
          if [ -n "${GITHUB_EVENT_PATH:-}" ] && [ -f "${GITHUB_EVENT_PATH}" ]; then
            chown builder:builder "${GITHUB_EVENT_PATH}" || true
            chmod a+r "${GITHUB_EVENT_PATH}" || true
          fi
      - name: Build package
        working-directory: pkgbuild
        run: |
          sudo -u builder makepkg -s --noconfirm
      - name: Upload Arch package
        uses: actions/upload-artifact@v4
        with:
          name: zash-arch
          path: pkgbuild/*.pkg.tar.zst

  deb_rpm:
    name: DEB & RPM via fpm
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - name: Build wheel
        run: |
          python -m pip install --upgrade pip
          python -m pip install build
          python -m build --wheel
      - name: Install fpm toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y ruby ruby-dev rubygems build-essential rpm
          sudo gem install --no-document fpm
      - name: Build .deb and .rpm
        run: |
          set -e
          wheel=$(ls dist/*.whl)
          fpm -s python -t deb \
            --no-python-dependencies \
            --maintainer "Leonardo Berbert <leo4berbert@gmail.com>" \
            --url "https://github.com/leoberbert/zash" \
            "$wheel"
          fpm -s python -t rpm \
            --no-python-dependencies \
            --maintainer "Leonardo Berbert <leo4berbert@gmail.com>" \
            --url "https://github.com/leoberbert/zash" \
            "$wheel"
      - name: Upload DEB/RPM
        uses: actions/upload-artifact@v4
        with:
          name: zash-deb-rpm
          path: |
            *.deb
            *.rpm

  release:
    name: Publish Release Assets
    needs: [arch, deb_rpm]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Download Arch artifact
        uses: actions/download-artifact@v4
        with:
          name: zash-arch
          path: artifacts
      - name: Download DEB/RPM artifacts
        uses: actions/download-artifact@v4
        with:
          name: zash-deb-rpm
          path: artifacts
      - name: Publish GitHub Release assets
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/*.pkg.tar.zst
            artifacts/*.deb
            artifacts/*.rpm
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
